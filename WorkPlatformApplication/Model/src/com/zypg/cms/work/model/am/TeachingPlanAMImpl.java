package com.zypg.cms.work.model.am;


import com.zypg.cms.work.model.am.common.TeachingPlanAM;
import com.zypg.cms.work.model.viewobject.book.query.CmsBookQVOImpl;
import com.zypg.cms.work.model.viewobject.book.query.CmsBookVOImpl;
import com.zypg.cms.work.model.viewobject.book.query.CmsBookVORowImpl;
import com.zypg.cms.work.model.viewobject.common.CmsDocCategoryRelTVOImpl;
import com.zypg.cms.work.model.viewobject.common.CmsDocCategoryRelTVORowImpl;
import com.zypg.cms.work.model.viewobject.common.CmsDocTVOImpl;
import com.zypg.cms.work.model.viewobject.common.CmsDocTVORowImpl;
import com.zypg.cms.work.model.viewobject.common.CmsDocUcmRelTVOImpl;
import com.zypg.cms.work.model.viewobject.relation.CmsDocRelTVOImpl;
import com.zypg.cms.work.model.viewobject.teachingplan.CmsTeachingPlanTVOImpl;
import com.zypg.cms.work.model.viewobject.teachingplan.CmsTeachingPlanTVORowImpl;
import com.zypg.cms.work.model.viewobject.teachingplan.query.CmsTeachingPlanQVOImpl;
import com.zypg.cms.work.model.viewobject.teachingplan.query.CmsTeachingPlanQueryVOImpl;
import com.zypg.cms.work.model.viewobject.teachingplan.query.CmsTeachingPlanVOImpl;

import oracle.jbo.Row;
import oracle.jbo.domain.Date;
import oracle.jbo.domain.Number;
import oracle.jbo.server.ApplicationModuleImpl;

// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Thu Apr 24 15:05:01 CST 2014
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class TeachingPlanAMImpl extends ApplicationModuleImpl implements TeachingPlanAM {
    /**
     * This is the default constructor (do not remove).
     */
    public TeachingPlanAMImpl() {
    }

    /**
     * Container's getter for CmsTeachingPlanVO1.
     * @return CmsTeachingPlanVO1
     */
    public CmsTeachingPlanVOImpl getCmsTeachingPlanVO() {
        return (CmsTeachingPlanVOImpl)findViewObject("CmsTeachingPlanVO");
    }

    /**
     * Container's getter for CmsTeachingPlanTVO.
     * @return CmsTeachingPlanTVO
     */
    public CmsTeachingPlanTVOImpl getCmsTeachingPlanTVO() {
        return (CmsTeachingPlanTVOImpl)findViewObject("CmsTeachingPlanTVO");
    }

    /**
     * Container's getter for CmsDocCategoryRelTVO.
     * @return CmsDocCategoryRelTVO
     */
    public CmsDocCategoryRelTVOImpl getCmsDocCategoryRelTVO() {
        return (CmsDocCategoryRelTVOImpl)findViewObject("CmsDocCategoryRelTVO");
    }

    /**
     * Container's getter for CmsDocTVO.
     * @return CmsDocTVO
     */
    public CmsDocTVOImpl getCmsDocTVO() {
        return (CmsDocTVOImpl)findViewObject("CmsDocTVO");
    }

    public Number preEditTeachingPlan(String mode, Number docId, String compCode) {
        this.getDBTransaction().getSession().getUserData().put("compCode", compCode);
        Number result = null;
        CmsTeachingPlanTVOImpl cmsTeachingPlanTVO = this.getCmsTeachingPlanTVO();
        if ("CREATE".equals(mode)) {
            CmsDocTVOImpl docVO = this.getCmsDocTVO();
            CmsDocTVORowImpl docNewRow = (CmsDocTVORowImpl)docVO.createRow();
            docNewRow.setStatus("TO_GATHER_TEACHING_PLAN");
            docNewRow.setLibCode("TEACHING_PLAN");
            docNewRow.setLibTypeCode("END_PROD_LIB");
            docNewRow.setCompCode(compCode);
            docVO.insertRow(docNewRow);
            //判断是否是从图书库进入
            CmsTeachingPlanTVORowImpl teachingPlanNewRow = (CmsTeachingPlanTVORowImpl)cmsTeachingPlanTVO.createRow();
            teachingPlanNewRow.setDocId(docNewRow.getDocId());
            if (docId != null) { //如果docId为空，代表直接从教案库创建，否则从图书库中创建教案
                CmsBookVOImpl bookVO = this.getCmsBookVO();
                bookVO.setbvDocId(docId);
                bookVO.executeQuery();
                CmsBookVORowImpl bookRow = (CmsBookVORowImpl)bookVO.first();
                if (bookRow != null) {
                    teachingPlanNewRow.setSourceBookName(bookRow.getBookName());
                    teachingPlanNewRow.setSourceBookIsbn(bookRow.getIsbn());
                    teachingPlanNewRow.setSourceBookDocId(bookRow.getDocId());
                    teachingPlanNewRow.setEditor(bookRow.getAuthor());
                    teachingPlanNewRow.setTeachingPlanName(bookRow.getBookName());
                    CmsDocCategoryRelTVOImpl docCategoryRelVO = this.getCmsDocCategoryRelTVO();
                    Row[] relRows = docCategoryRelVO.getFilteredRows("DocId", docId);
                    if (relRows.length > 0) {
                        CmsDocCategoryRelTVORowImpl docCategoryRelRow = (CmsDocCategoryRelTVORowImpl)relRows[0];
                        System.out.println("docCategoryRelRow.getCategoryId():" + docCategoryRelRow.getCategoryId());
                        preDocCategroupRel(docNewRow.getDocId(), docCategoryRelRow.getCategoryId());
                    } else {
                        preDocCategroupRel(docNewRow.getDocId(), new Number(-1));
                    }
                }
            }
            teachingPlanNewRow.setTeachingPlanStoreTime(new oracle.jbo.domain.Date(new java.sql.Timestamp(new java.util.Date().getTime())));
            cmsTeachingPlanTVO.insertRow(teachingPlanNewRow);
            result = docNewRow.getDocId();
        } else {
            cmsTeachingPlanTVO.setbvDocId(docId);
            cmsTeachingPlanTVO.executeQuery();
            Row row = cmsTeachingPlanTVO.first();
            if (row != null) {
                row.setAttribute("LastUpdateDate", new Date());
                cmsTeachingPlanTVO.setCurrentRow(row);
            }
            result = docId;
        }
        return result;
    }

    public void preDocCategroupRel(Number docId, Number categoryId) {
        CmsDocCategoryRelTVOImpl docCategoryRelVO = this.getCmsDocCategoryRelTVO();
        docCategoryRelVO.setbvDocId(docId);
        docCategoryRelVO.executeQuery();
        Row row = docCategoryRelVO.first();
        if (row == null) {
            CmsDocCategoryRelTVORowImpl docCategoryRelNewRow =
                (CmsDocCategoryRelTVORowImpl)docCategoryRelVO.createRow();
            docCategoryRelNewRow.setDocId(docId);
            docCategoryRelNewRow.setCategoryGroupType("BY_CATEGORY");
            docCategoryRelNewRow.setCategoryId(categoryId);
            docCategoryRelVO.insertRow(docCategoryRelNewRow);
        } else {
            CmsDocCategoryRelTVORowImpl docCategoryRelNewRow = (CmsDocCategoryRelTVORowImpl)row;
            docCategoryRelNewRow.setCategoryId(categoryId);
        }
    }

    public void initTeachingplanInfo4View(Number docId) {
        CmsTeachingPlanTVOImpl teachingplanVO = this.getCmsTeachingPlanTVO4View();
        teachingplanVO.setbvDocId(docId);
        teachingplanVO.executeQuery();
        CmsDocUcmRelTVOImpl durTVO = this.getCmsDocUcmRelTVO4FileList();
        durTVO.setbvDocId(docId);
        durTVO.executeQuery();
        Row row = teachingplanVO.first();
        if (row != null) {
            teachingplanVO.setCurrentRow(row);
        }
    }

    public long initOnlineReadInfo(Number docId) {
        CmsDocUcmRelTVOImpl onlineReadVO = this.getCmsDocUcmRelTVO4OnlineRead();
        onlineReadVO.setbvDocId(docId);
        onlineReadVO.executeQuery();
        onlineReadVO.setRangeSize(-1);
        return onlineReadVO.getEstimatedRowCount();
    }

    /**
     * 初始化高级查询面板
     */
    public void initComplexSearch4TeachingPlan() {
        CmsTeachingPlanQVOImpl vo = this.getCmsTeachingPlanQVO();
        vo.executeQuery();
        vo.setCurrentRow(vo.first());
    }


    /**
     * Container's getter for CmsBookVO.
     * @return CmsBookVO
     */
    public CmsBookVOImpl getCmsBookVO() {
        return (CmsBookVOImpl)findViewObject("CmsBookVO");
    }

    /**
     * Container's getter for CmsDocRelTVO.
     * @return CmsDocRelTVO
     */
    public CmsDocRelTVOImpl getCmsDocRelTVO() {
        return (CmsDocRelTVOImpl)findViewObject("CmsDocRelTVO");
    }

    /**
     * Container's getter for CmsTeachingPlanTVO4View.
     * @return CmsTeachingPlanTVO4View
     */
    public CmsTeachingPlanTVOImpl getCmsTeachingPlanTVO4View() {
        return (CmsTeachingPlanTVOImpl)findViewObject("CmsTeachingPlanTVO4View");
    }

    /**
     * Container's getter for CmsDocUcmRelTVO4FileList.
     * @return CmsDocUcmRelTVO4FileList
     */
    public CmsDocUcmRelTVOImpl getCmsDocUcmRelTVO4FileList() {
        return (CmsDocUcmRelTVOImpl)findViewObject("CmsDocUcmRelTVO4FileList");
    }

    /**
     * Container's getter for CmsDocUcmRelTVO4OnlineRead.
     * @return CmsDocUcmRelTVO4OnlineRead
     */
    public CmsDocUcmRelTVOImpl getCmsDocUcmRelTVO4OnlineRead() {
        return (CmsDocUcmRelTVOImpl)findViewObject("CmsDocUcmRelTVO4OnlineRead");
    }

    /**
     * Container's getter for CmsTeachingPlanQueryVO.
     * @return CmsTeachingPlanQueryVO
     */
    public CmsTeachingPlanQueryVOImpl getCmsTeachingPlanQueryVO() {
        return (CmsTeachingPlanQueryVOImpl)findViewObject("CmsTeachingPlanQueryVO");
    }

    /**
     * Container's getter for CmsTeachingPlanQVO.
     * @return CmsTeachingPlanQVO
     */
    public CmsTeachingPlanQVOImpl getCmsTeachingPlanQVO() {
        return (CmsTeachingPlanQVOImpl)findViewObject("CmsTeachingPlanQVO");
    }
}
